<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>报告查看器</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f4; line-height: 1.6; }
        .container { max-width: 1000px; margin: auto; background-color: #fff; padding: 20px 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0; margin-bottom: 10px; }
        h1 small { font-size: 0.5em; font-weight: normal; color: #777; margin-left: 8px; }
        .header-description { font-size: 15px; color: #555; margin-top: 0; margin-bottom: 20px; }
        pre { white-space: pre-wrap; word-wrap: break-word; background-color: #2d2d2d; color: #f1f1f1; padding: 15px; border-radius: 5px; font-family: "SF Mono", "Courier New", Courier, monospace; font-size: 14px; }
        pre a { color: #61dafb; text-decoration: underline; }
        pre a:hover { color: #bbeffd; }
        .button-container { display: flex; gap: 10px; margin-bottom: 15px; }
        .button { padding: 8px 15px; font-size: 14px; font-weight: bold; color: #fff; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.2s; }
        .button:active { transform: scale(0.98); }
        .copy-button { background-color: #007bff; }
        .copy-button:hover { background-color: #0056b3; }
        .share-button { background-color: #17a2b8; }
        .share-button:hover { background-color: #117a8b; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-box { position: relative; background-color: #fff; padding: 20px 25px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 500px; display: flex; flex-direction: column; max-height: 90vh; transform: scale(0.9); transition: transform 0.3s; }
        .modal-overlay.visible .modal-box { transform: scale(1); }
        .modal-box h2 { margin-top: 0; color: #333; flex-shrink: 0; font-size: 20px; margin-bottom: 15px; }
        .modal-content { overflow-y: auto; margin: 0; padding-right: 10px; }
        .modal-box ol { padding-left: 20px; color: #555; margin: 0; }
        .modal-box li { margin-bottom: 8px; font-size: 14px; line-height: 1.5; }
        .modal-actions { text-align: right; margin-top: auto; padding-top: 15px; flex-shrink: 0; }
        .modal-confirm-button { background-color: #28a745; }
        .modal-confirm-button:hover { background-color: #218838; }
        .modal-close-button { position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; color: #aaa; background: none; border: none; cursor: pointer; line-height: 1; }
        .modal-close-button:hover { color: #333; }
    </style>
</head>
<body>

    <div class="container">
        <h1 id="headerTitle"></h1>
        <p id="headerDescription"></p>
        <p id="loadingStatus" style="font-weight: bold; color: #007bff;"></p>
        <div id="controls" style="display: none;">
            <div class="button-container">
                <button class="button copy-button" id="copyBtn"></button>
                <button class="button share-button" id="shareBtn"></button>
            </div>
            <pre id="log-content"></pre>
        </div>
    </div>

    <div class="modal-overlay" id="infoModal">
        <div class="modal-box">
            <button class="modal-close-button" id="closeModalBtn">&times;</button>
            <h2 id="modalHeader"></h2>
            <div class="modal-content">
                <ol>
                    <li id="modalStep1"></li>
                    <li id="modalStep2"></li>
                    <li id="modalStep3"></li>
                    <li id="modalStep4"></li>
                </ol>
            </div>
            <div class="modal-actions">
                <button class="button modal-confirm-button" id="confirmBtn"></button>
            </div>
        </div>
    </div>

    <script>
        const translations = {
            en: {
                pageTitle: "Report Viewer",
                headerTitle: "Don't Starve Error Report Details",
                headerAttribution: "(Generated by Crash Nevermind Mod)",
                headerDescription: "We have generated a recent error report. You can use the buttons below to copy the report or generate a shareable link to send to the corresponding mod developer for troubleshooting.",
                copyButton: "Copy Report",
                copyButtonSuccess: "Copied!",
                copyFailed: "Copy failed. Your browser might not support this feature or permission was denied. Please copy the text manually.",
                shareButton: "Get Sharable Link",
                logLoading: "Initializing loader...",
                logError: "Error: Failed to decode the final data.",
                logNotFound: "No Task ID found in URL. Please generate the report from the mod again.",
                modalHeader: "Share Your Report as a Link",
                modalStep1: "The report content has been successfully copied to your clipboard.",
                modalStep2: "In the new page, paste the text into the input field under <b>New Paste</b> using <b>Ctrl+V</b> or by <b>right-clicking and selecting Paste</b>.",
                modalStep3: "Find and click the <b>Create New Paste</b> button at the bottom of the page to create the share.",
                modalStep4: "Once created, you can copy the new page link from your browser's <b>address bar</b>, or by <b>right-clicking the page -> Copy Page URL</b>.",
                modalConfirmButton: "Continue to Sharing Site"
            },
            zh: {
                pageTitle: "报告查看器",
                headerTitle: "饥荒错误报告详情",
                headerAttribution: "(由 崩溃？别在意 生成)",
                headerDescription: "我们生成了近期错误报告。你可以通过下方的按钮复制报告，或生成一个分享链接，并将其发送给对应的 Mod 开发者以协助定位问题。",
                copyButton: "复制报告",
                copyButtonSuccess: "已复制！",
                copyFailed: "复制失败。您的浏览器可能不支持此功能或未授予权限，请手动复制文本。",
                shareButton: "获取分享链接",
                logLoading: "正在初始化加载器...",
                logError: "错误：未能成功解码最终数据。",
                logNotFound: "URL中未找到任务ID。请从Mod中重新生成报告。",
                modalHeader: "分享你的报告为链接",
                modalStep1: "报告内容已成功复制到你的剪贴板。",
                modalStep2: "在新打开的页面中，使用 <b>Ctrl+V</b> 或<b>右键粘贴</b>文本到 <b>New Paste</b> 下方的输入栏。",
                modalStep3: "在网页最下方，找到并点击 <b>Create New Paste</b> 按钮来创建分享。",
                modalStep4: "创建成功后，你可以从浏览器<b>地址栏</b>复制新页面的链接，或者在页面上<b>右键 -> 复制网页URL</b>。",
                modalConfirmButton: "继续前往分享网站"
            }
        };

        window.addEventListener('DOMContentLoaded', () => {
            function getLanguage() {
                const browserLang = navigator.language || navigator.userLanguage;
                if (browserLang.startsWith('zh')) { return 'zh'; }
                return 'en';
            }
            const currentLang = getLanguage();
            const T = translations[currentLang];

            function applyTranslations() {
                document.documentElement.lang = currentLang;
                document.title = T.pageTitle;
                document.getElementById('headerTitle').innerHTML = `${T.headerTitle} <small>${T.headerAttribution}</small>`;
                document.getElementById('headerDescription').textContent = T.headerDescription;
                document.getElementById('copyBtn').textContent = T.copyButton;
                document.getElementById('shareBtn').textContent = T.shareButton;
                document.getElementById('modalHeader').textContent = T.modalHeader;
                document.getElementById('modalStep1').innerHTML = T.modalStep1;
                document.getElementById('modalStep2').innerHTML = T.modalStep2;
                document.getElementById('modalStep3').innerHTML = T.modalStep3;
                document.getElementById('modalStep4').innerHTML = T.modalStep4;
                document.getElementById('confirmBtn').textContent = T.modalConfirmButton;
            }

            const logElement = document.getElementById('log-content');
            const copyBtn = document.getElementById('copyBtn');
            const shareBtn = document.getElementById('shareBtn');
            const infoModal = document.getElementById('infoModal');
            const confirmBtn = document.getElementById('confirmBtn');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const loadingStatusEl = document.getElementById('loadingStatus');
            const controlsEl = document.getElementById('controls');
            const pageLoadTime = Date.now();

            applyTranslations();

            async function copyTextToClipboard(text) {
                if (navigator.clipboard) {
                    try {
                        await navigator.clipboard.writeText(text);
                        return true;
                    } catch (err) {
                        console.error('Failed to copy with navigator.clipboard:', err);
                    }
                }
                let success = false;
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.top = '-9999px';
                textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    success = document.execCommand('copy');
                } catch (err) {
                    console.error('Failed to copy with execCommand:', err);
                    success = false;
                }
                document.body.removeChild(textArea);
                return success;
            }

            function linkifyText(text) {
                const escapedText = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
                const regex = /(workshop-\d+)/g;
                return escapedText.replace(regex, (match) => {
                    const workshopId = match.split('-')[1];
                    const url = `https://steamcommunity.com/sharedfiles/filedetails/?id=${workshopId}`;
                    return `<a href="${url}" target="_blank" rel="noopener noreferrer">${match}</a>`;
                });
            }

            copyBtn.addEventListener('click', async () => {
                const success = await copyTextToClipboard(logElement.textContent);
                if (success) {
                    copyBtn.textContent = T.copyButtonSuccess;
                    copyBtn.style.backgroundColor = '#28a745';
                    setTimeout(() => {
                        copyBtn.textContent = T.copyButton;
                        copyBtn.style.backgroundColor = '#007bff';
                    }, 1500);
                } else {
                    alert(T.copyFailed); 
                }
            });

            function showModal() { infoModal.classList.add('visible'); }
            function hideModal() { infoModal.classList.remove('visible'); }

            shareBtn.addEventListener('click', async () => {
                const success = await copyTextToClipboard(logElement.textContent);
                if (success) {
                    showModal();
                } else {
                    alert(T.copyFailed); 
                }
            });

            confirmBtn.addEventListener('click', () => { window.open('https://pastebin.com', '_blank'); });
            closeModalBtn.addEventListener('click', hideModal);
            infoModal.addEventListener('click', (event) => { if (event.target === infoModal) { hideModal(); } });
            
            const taskId = window.location.hash.substring(1);

            if (!taskId) {
                loadingStatusEl.textContent = T.logNotFound;
                return;
            }

            loadingStatusEl.textContent = T.logLoading;

            let totalChunks = -1;
            const collectedChunks = {};
            let receivedCount = 0;
            const POLLING_INTERVAL = 500;
            const TIMEOUT = 30000;
            const SLOW_NOTICE_TIMEOUT = 10000;

            const slowNoticeHandle = setTimeout(() => {
                const slowMessage = (currentLang === 'zh') ? "获取报告可能失败了，请重新获取，但程序仍会继续尝试..." : "Loading is taking longer than usual, please try generating the report again. The page will continue to attempt loading...";
                if (receivedCount < totalChunks || totalChunks === -1) {
                    loadingStatusEl.textContent = slowMessage;
                }
            }, SLOW_NOTICE_TIMEOUT);

            const polling = setInterval(checkStorage, POLLING_INTERVAL);
            const timeout = setTimeout(() => {
                clearInterval(polling);
                clearTimeout(slowNoticeHandle);
                const stillLoading = receivedCount < totalChunks || totalChunks === -1;
                if(stillLoading){
                    const timeoutMessage = (currentLang === 'zh') ? `错误：超时。最终收到 ${receivedCount} / ${totalChunks > 0 ? totalChunks : '未知'} 个数据块。` : `Error: Timed out. Received ${receivedCount} of ${totalChunks > 0 ? totalChunks : 'unknown'} chunks.`;
                    loadingStatusEl.textContent = timeoutMessage;
                    setTimeout(() => {
                        window.close();
                    }, 10000);
                }
                cleanupTaskData(taskId, totalChunks > 0 ? totalChunks : 50);
            }, TIMEOUT);

            function checkStorage() {
                if (totalChunks === -1) {
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith(`log_task_${taskId}_chunk_`)) {
                            const item = JSON.parse(localStorage.getItem(key));
                            if (item && item.total) {
                                totalChunks = item.total;
                                break;
                            }
                        }
                    }
                }
                if (totalChunks === -1) return;
                receivedCount = 0;
                for (let i = 1; i <= totalChunks; i++) {
                    if (!collectedChunks[i]) {
                        const key = `log_task_${taskId}_chunk_${i}`;
                        const item = localStorage.getItem(key);
                        if (item) {
                            collectedChunks[i] = JSON.parse(item).data;
                        }
                    }
                    if (collectedChunks[i]) {
                        receivedCount++;
                    }
                }
                if (Date.now() - pageLoadTime < SLOW_NOTICE_TIMEOUT) {
                    const progressMessage = (currentLang === 'zh') ? `加载中... 已收到 ${receivedCount} / ${totalChunks} 个数据块。` : `Loading... Received ${receivedCount} / ${totalChunks} chunks.`;
                    loadingStatusEl.textContent = progressMessage;
                }
                if (receivedCount === totalChunks) {
                    clearInterval(polling);
                    clearTimeout(timeout);
                    clearTimeout(slowNoticeHandle);
                    const successMessage = (currentLang === 'zh') ? "所有数据块已收到，正在组合..." : "All chunks received. Assembling...";
                    loadingStatusEl.textContent = successMessage;
                    let fullBase64 = "";
                    for (let i = 1; i <= totalChunks; i++) {
                        fullBase64 += collectedChunks[i];
                    }
                    try {
                        const decodedText = decodeURIComponent(escape(window.atob(fullBase64)));
                        const linkifiedHtml = linkifyText(decodedText);
                        logElement.innerHTML = linkifiedHtml;
                        loadingStatusEl.style.display = 'none';
                        controlsEl.style.display = 'block';
                    } catch (e) {
                        loadingStatusEl.textContent = T.logError;
                    } finally {
                        cleanupTaskData(taskId, totalChunks);
                    }
                }
            }
            
            function cleanupTaskData(currentTaskId, count) {
                for (let i = 1; i <= count; i++) {
                    localStorage.removeItem(`log_task_${currentTaskId}_chunk_${i}`);
                }
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('log_task_') && !key.startsWith(`log_task_${currentTaskId}_`)) {
                        keysToRemove.push(key);
                    }
                }
                keysToRemove.forEach(key => localStorage.removeItem(key));
            }
        });
    </script>

</body>
</html>
